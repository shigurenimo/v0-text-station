---
name: infer-code-rules
description: "コードベースから設計パターン・規約を抽出してローカルルールに記録する。別のスキルから呼び出すか、コマンドで明示的に実行する。"
disable-model-invocation: true
---

# Infer Code Rules

コードベースから設計パターン・規約を抽出し、ローカルルールとして記録する。

このスキルは自動トリガーされない。別のスキルから呼び出すか、コマンドで明示的に実行する。

## オプション

- `--full` - すべてのカテゴリを分析して包括的なルールを出力
- `--category <name>` - 特定カテゴリのみ分析
- `--output` - 分析結果をルールファイルに書き込む（デフォルトは標準出力のみ）

## 実行コンテキスト

- **サブエージェント実行時**: ファイルを更新せず、抽出結果のみを返す。メイン側で AskUserQuestion 確認後にファイルを更新する
- **メイン実行時**: AskUserQuestion で確認後にファイルを更新する
- `--output` オプション: 確認なしでファイルを更新（自動化用）

**必須**: ファイル更新前には必ず AskUserQuestion でユーザーに確認する（`--output` 指定時を除く）。

## ルールファイルの配置

`.claude/rules/local.{category}.md`

例:

- `local.react.components.md` - コンポーネントパターン
- `local.react.routes.md` - ルートパターン
- `local.ui-design.md` - UIデザインパターン
- `local.tests.md` - テストパターン

`local.` プレフィックスは、このプロジェクト固有のルールであることを示す。

## 実行手順

### ステップ1: 既存ルールの確認

まず既存のルールファイルを確認し、重複を避ける。

```bash
ls .claude/rules/
```

### ステップ2: コードベースの探索

対象ディレクトリを探索してパターンを収集する。

探索対象の例:

- `app/routes/` - ルートパターン
- `app/components/` - コンポーネントパターン
- `app/components/ui/` - UIライブラリカスタマイズ
- `app/hooks/` - フックパターン
- `app/contexts/` - Context パターン
- `app/utils/` - ユーティリティ関数
- `app/lib/` - ライブラリ・クエリ

### ステップ3: パターンの抽出

探索の観点:

- コードスタイル・フォーマット（セミコロン、インデント、パス）
- 命名規則（ファイル、関数、型、定数）
- TypeScript パターン（type vs interface など）
- コンポーネント構造（Props定義、早期リターン）
- 状態管理（Context、useReducer、外部ライブラリ）
- フォーム処理
- エラー処理
- テストパターン

### ステップ4: 既存ルールとの照合

抽出したパターンが既存ルールと矛盾しないか確認する。

- 矛盾がある場合 → 結果に矛盾を記載してメインに返す
- 重複する場合 → 追加しない

### ステップ5: 結果を返す

**サブエージェントとして実行された場合:**

ルールファイルを直接更新せず、抽出結果をメインに返す。
メイン側で AskUserQuestion 確認後にファイルを更新する。

**メインで実行された場合:**

AskUserQuestion でユーザーに確認してからルールファイルを作成・更新する。

## ルールファイルのフォーマット

```markdown
---
paths: "app/components/**/*.tsx"
---

# Local Component Rules

## セクション名

説明文。

コード例 (必要な場合のみ)。
```

`paths` フロントマターで適用範囲を指定する。

## 出力フォーマット（--full オプション）

`--full` を指定した場合、以下のセクションを含む包括的なレポートを出力する:

1. コードスタイル・フォーマット
2. 命名規則
3. TypeScript パターン
4. コンポーネントパターン
5. 状態管理
6. フォーム処理
7. API パターン
8. エラー処理
9. テストパターン
10. スタイリング
11. 重要ルールまとめ

## 注意事項

- 既存ルールと矛盾する場合は必ず報告する
- コード例は簡潔に
- 「なぜそうするか」の理由も記録
- ルール追加の判断基準は `.workflow.md` の「ルール追加の提案」に従う
- プロジェクト固有のパターンを発見した場合は優先的に抽出する
